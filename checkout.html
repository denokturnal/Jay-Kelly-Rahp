<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Jay Kelly Rahp</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/cart.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="navbar">
        <div class="container">
            <a href="index.html" class="logo">JKR</a>
            <nav class="nav-links">
                <a href="index.html#home" class="nav-link">Home</a>
                <a href="index.html#music" class="nav-link">Music</a>
                <a href="index.html#videos" class="nav-link">Videos</a>
                <a href="index.html#events" class="nav-link">Events</a>
                <a href="index.html#shop" class="nav-link">Shop</a>
                <a href="index.html#booking" class="nav-link">Booking</a>
                <a href="checkout.html" class="nav-link cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-count" class="cart-count">0</span>
                </a>
            </nav>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </header>

    <main class="checkout-page-content">
        <section id="checkout" class="section checkout-section">
            <div class="container">
                <h2 class="section-title">Finalize Your Order</h2>
                
                <div class="checkout-grid">
                    <div class="cart-details">
                        <h3 class="section-subtitle">Your Cart is empty, add some dope Items from our shop</h3>
                        <div id="checkout-items">
                            <div class="empty-cart" style="display: none; text-align: center; padding: 50px;">
                                <i class="fas fa-shopping-cart fa-3x" style="color: #ff3c78;"></i>
                                <p style="margin-top: 15px; font-size: 1.2em;">Your cart is empty. Let's find some dope merch!</p>
                                <a href="shop.html" class="btn btn-primary" style="margin-top: 20px;">Go to Shop</a>
                            </div>
                            <!-- Cart items will be dynamically inserted here -->
                        </div>
                        
                        <!-- Order Summary Section -->
                        <div class="order-summary-container">
                            <div id="order-summary" class="order-summary">
                                <h3>
                                    <span>Order Summary</span>
                                    <span class="item-count">0 Items</span>
                                </h3>
                                <div class="summary-details">
                                    <div class="summary-row">
                                        <span>Subtotal</span>
                                        <span class="subtotal-amount">GHÂ¢0.00</span>
                                    </div>
                                </div>
                                <div class="total-row">
                                    <span>Total</span>
                                    <span class="total-amount">GHÂ¢0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="checkout-form-container">
                        <form id="checkout-form" class="checkout-form card">
                            <h2 class="section-subtitle">Local Order / Shipping Information</h2>
                            
                            <div class="form-group">
                                <label for="name">Full Name <span class="required">*</span></label>
                                <input type="text" id="name" name="name" autocomplete="name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email (Optional)</label>
                                <input type="email" id="email" name="email" autocomplete="email">
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone (WhatsApp) <span class="required">*</span></label>
                                <input type="tel" id="phone" name="phone" autocomplete="tel" required>
                            </div>
                            <div class="form-group">
                                <label for="address">Local Order - (GPS Address) / Shipping Address <span class="required">*</span></label>
                                <textarea id="address" name="address" rows="3" autocomplete="street-address" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="notes">Order Notes (Size, Color, etc.)</label>
                                <textarea id="notes" name="notes" rows="2" autocomplete="off"></textarea>
                            </div>

                            <div class="checkout-buttons">
                                <button type="submit" id="whatsapp-checkout" class="btn btn-primary btn-block checkout-btn">
                                    <i class="fab fa-whatsapp"></i> Proceed To Checkout
                                </button>
                                <br>
                                <a href="shop.html" class="btn btn-outline btn-block" id="continue-shopping-btn">
                                    <i class="fas fa-arrow-left"></i> Continue Shopping
                                </a>
                            </div>
                            <p class="checkout-note">
                                All orders are finalized via WhatsApp to confirm payment and shipping details.
                            </p>
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div class="music-player">
        <div class="player-controls">
            </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; <span class="current-year">2024</span> Jay Kelly Rahp. All rights reserved.</p>
        </div>
    </footer>
    
    <script src="js/main.js"></script>
    <script src="js/checkout.js"></script>

    <script>
        // Use the global 'cart' array and functions from main.js
        
        // Format price helper (used for the WhatsApp message)
        function formatPrice(price) {
            return 'GHÂ¢' + parseFloat(price).toFixed(2);
        }

        // Function to send message to WhatsApp
        function sendToWhatsApp(phone, text) {
            // Encode the message for URL
            const encodedText = encodeURIComponent(text);
            // Open WhatsApp with the message
            window.open(`https://wa.me/${phone}?text=${encodedText}`, '_blank');
        }

        // Function to show notification
        function showNotification(message) {
            // Check if notification element exists, if not create it
            let notification = document.querySelector('.notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.className = 'notification';
                document.body.appendChild(notification);
                
                // Add some basic styling
                const style = document.createElement('style');
                style.textContent = `
                    .notification {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #4CAF50;
                        color: white;
                        padding: 15px 25px;
                        border-radius: 4px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        z-index: 1000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    .notification.show {
                        opacity: 1;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Set message and show
            notification.textContent = message;
            notification.classList.add('show');
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Function to update cart display
        function updateOrderSummary(cart) {
            const orderSummary = document.getElementById('order-summary');
            if (!orderSummary) return;
            
            if (!cart || cart.length === 0) {
                orderSummary.style.display = 'none';
                return;
            }
            
            // Calculate subtotal
            const subtotal = cart.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                return sum + (price * quantity);
            }, 0);
            
            // Update summary elements
            const itemCountElement = orderSummary.querySelector('.item-count');
            const subtotalElement = orderSummary.querySelector('.subtotal-amount');
            const totalElement = orderSummary.querySelector('.total-amount');
            
            if (itemCountElement) {
                const itemCount = cart.reduce((sum, item) => sum + (parseInt(item.quantity) || 1), 0);
                itemCountElement.textContent = `${itemCount} ${itemCount === 1 ? 'Item' : 'Items'}`;
            }
            
            if (subtotalElement) {
                subtotalElement.textContent = `GHÂ¢${subtotal.toFixed(2)}`;
            }
            
            if (totalElement) {
                totalElement.textContent = `GHÂ¢${subtotal.toFixed(2)}`; // Total is same as subtotal for now
            }
            
            orderSummary.style.display = 'block';
        }
        
        // Function to proceed to checkout
        function proceedToCheckout() {
            // Scroll to the checkout form
            document.getElementById('checkout-form').scrollIntoView({ 
                behavior: 'smooth' 
            });
            
            // Clear the cart
            localStorage.removeItem('cart');
            
            // Show success message
            showNotification('Order placed successfully! Your cart has been cleared.');
            
            // Update the cart display
            updateCartDisplay();
            
            // Clear the form
            document.getElementById('checkout-form').reset();
        }
        
        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('checkout-items');
            const emptyCartDiv = document.querySelector('.empty-cart');
            const orderSummary = document.getElementById('order-summary');
            
            // Get cart from localStorage or initialize empty array
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            // Filter out any invalid items and remove duplicates
            const seenItems = new Map();
            
            // Process cart to combine duplicate items
            cart = cart.reduce((uniqueItems, item) => {
                if (!item || !item.name || isNaN(parseFloat(item.price))) return uniqueItems;
                
                const itemKey = `${item.name}-${item.price}`;
                const existingItem = seenItems.get(itemKey);
                
                if (existingItem) {
                    // If item exists, update quantity
                    existingItem.quantity = (parseInt(existingItem.quantity) || 1) + (parseInt(item.quantity) || 1);
                } else {
                    // Add new item
                    const newItem = { ...item };
                    newItem.quantity = parseInt(newItem.quantity) || 1;
                    seenItems.set(itemKey, newItem);
                    uniqueItems.push(newItem);
                }
                
                return uniqueItems;
            }, []);
            
            // Save the processed cart back to localStorage
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Calculate total number of items and subtotal
            let totalItems = 0;
            let subtotal = 0;
            
            cart.forEach(item => {
                const quantity = parseInt(item.quantity) || 1;
                totalItems += quantity;
                subtotal += parseFloat(item.price) * quantity;
            });
            
            // Update cart count in navigation
            const cartCountElements = document.querySelectorAll('.cart-count');
            cartCountElements.forEach(el => {
                el.textContent = totalItems;
                el.style.display = totalItems > 0 ? 'flex' : 'none';
            });
            
            // Show/hide empty cart message and order summary
            if (cart.length === 0) {
                if (emptyCartDiv) emptyCartDiv.style.display = 'block';
                if (orderSummary) orderSummary.style.display = 'none';
                if (cartItemsContainer) cartItemsContainer.innerHTML = '';
                return;
            }
            
            // Show order summary and hide empty cart message
            if (emptyCartDiv) emptyCartDiv.style.display = 'none';
            if (orderSummary) orderSummary.style.display = 'block';
            
            // Update the item count in the order summary
            const itemCountElement = document.querySelector('.item-count');
            const subtotalElement = document.querySelector('.subtotal-amount');
            const totalElement = document.querySelector('.total-amount');
            
            if (itemCountElement) {
                itemCountElement.textContent = `${totalItems} Item${totalItems !== 1 ? 's' : ''}`;
            }
            
            if (subtotalElement) {
                subtotalElement.textContent = `GHÂ¢${subtotal.toFixed(2)}`;
            }
            
            if (totalElement) {
                totalElement.textContent = `GHÂ¢${subtotal.toFixed(2)}`;
            }
            
            // Clear existing items and update cart display
            if (cartItemsContainer) {
                cartItemsContainer.innerHTML = `
                    <div class="cart-header">
                        Your Cart (${totalItems} Item${totalItems !== 1 ? 's' : ''})
                    </div>
                    <div id="cart-items-list">
                        ${cart.map(item => `
                            <div class="cart-item">
                                <div class="cart-item-image">
                                    <img src="${item.image || 'img/placeholder.jpg'}" alt="${item.name}">
                                </div>
                                <div class="cart-item-details">
                                    <div class="cart-item-name">${item.name}</div>
                                    <div class="cart-item-price">GHÂ¢${parseFloat(item.price).toFixed(2)} Ã— ${item.quantity || 1}</div>
                                    <button onclick="removeFromCart('${item.name.replace(/'/g, "\\'")}')" class="remove-item">
                                        Remove
                                    </button>
                                </div>
                                <div class="cart-item-total">
                                    GHÂ¢${(parseFloat(item.price) * (item.quantity || 1)).toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
    
    // Update the order summary with totals
    updateOrderSummary(cart);
}
        
        // Function to handle quantity updates
        function handleQuantityUpdate(input, itemName, priceCell, totalCell) {
            const newQuantity = parseInt(input.value);
            if (isNaN(newQuantity) || newQuantity < 1) {
                input.value = 1;
                return;
            }

            // Update the display
            const display = input.previousElementSibling;
            display.textContent = newQuantity;
            
            // Calculate new total
            const price = parseFloat(priceCell.textContent.replace('GHÂ¢', ''));
            const newTotal = price * newQuantity;
            totalCell.textContent = `GHÂ¢${newTotal.toFixed(2)}`;
            
            // Update cart in localStorage
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const itemIndex = cart.findIndex(item => item.name === itemName);
            
            if (itemIndex > -1) {
                cart[itemIndex].quantity = newQuantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                
                // Update subtotal
                updateSubtotal();
            }
        }

        // Function to update subtotal
        function updateSubtotal() {
            const rows = document.querySelectorAll('.cart-table tbody tr:not(:last-child)');
            let subtotal = 0;
            
            rows.forEach(row => {
                const price = parseFloat(row.querySelector('td:nth-child(2)').textContent.replace('GHÂ¢', ''));
                const quantity = parseInt(row.querySelector('.quantity-display').textContent);
                subtotal += price * quantity;
            });
            
            const subtotalCell = document.querySelector('.subtotal-amount');
            if (subtotalCell) {
                subtotalCell.textContent = `GHÂ¢${subtotal.toFixed(2)}`;
            }
            
            return subtotal;
        }

        // Handle coupon application
        function applyCoupon() {
            const couponInput = document.querySelector('.coupon-input');
            if (!couponInput) return;
            
            const couponCode = couponInput.value.trim();
            if (!couponCode) {
                showNotification('Please enter a coupon code');
                return;
            }
            
            // Here you would typically validate the coupon with your backend
            // For now, we'll just show a success message
            showNotification('Coupon applied successfully!');
            couponInput.value = '';
        }
        
        // Initialize cart display and event listeners
        document.addEventListener('DOMContentLoaded', function() {
            updateCartDisplay();
            
            // Handle apply coupon button click
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn') && e.target.closest('.coupon-section')) {
                    applyCoupon();
                }
            });
            
            // Handle coupon input enter key
            document.addEventListener('keydown', function(e) {
                if (e.target.classList.contains('coupon-input') && e.key === 'Enter') {
                    e.preventDefault();
                    applyCoupon();
                }
            });
            
            // Handle action buttons
            document.addEventListener('click', function(e) {
                const button = e.target.closest('.action-buttons .btn');
                if (!button) return;
                
                if (button.textContent.includes('Update Cart')) {
                    // Update cart quantities
                    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const quantityInputs = document.querySelectorAll('.quantity-input');
                    
                    quantityInputs.forEach((input, index) => {
                        const newQty = parseInt(input.value) || 1;
                        if (cart[index]) {
                            cart[index].quantity = newQty;
                        }
                    });
                    
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartDisplay();
                    showNotification('Cart updated successfully!');
                    
                } else if (button.textContent.includes('Continue Shopping')) {
                    // Go back to shop
                    window.location.href = 'shop.html';
                    
                } else if (button.textContent.includes('Proceed to Checkout')) {
                    // Scroll to the checkout form
                    document.getElementById('checkout-form').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }
            });
            
            // Delegate events for quantity updates
            document.addEventListener('click', function(e) {
                const quantityDisplay = e.target.closest('.quantity-display');
                if (quantityDisplay) {
                    const cell = quantityDisplay.closest('.quantity-cell');
                    const input = cell.querySelector('.quantity-input');
                    quantityDisplay.style.display = 'none';
                    input.style.display = 'inline-block';
                    input.focus();
                }
            });
            
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('quantity-input')) {
                    const input = e.target;
                    const cell = input.closest('.quantity-cell');
                    const display = cell.querySelector('.quantity-display');
                    const row = cell.closest('tr');
                    const itemName = row.querySelector('td:first-child span').textContent;
                    const priceCell = row.querySelector('td:nth-child(2)');
                    const totalCell = row.querySelector('td:last-child');
                    
                    handleQuantityUpdate(input, itemName, priceCell, totalCell);
                    
                    // Hide input and show display
                    input.style.display = 'none';
                    display.style.display = 'inline-block';
                }
            });
            
            // Handle Enter key on quantity input
            document.addEventListener('keydown', function(e) {
                if (e.target.classList.contains('quantity-input') && e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
        });

        // Handle WhatsApp checkout button submission
        document.getElementById('checkout-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // Get form data
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            // Validation
            if (!name || !phone || !address) {
                showNotification('Please fill in all required fields (marked with *).');
                return;
            }
            
            // Get cart from localStorage
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            if (cart.length === 0) {
                showNotification('Your cart is empty.');
                return;
            }
            
            // Format order message
            let message = `*NEW ORDER REQUEST*\n\n`;
            message += `*Customer Information*\n`;
            message += `ðŸ‘¤ *Name:* ${name}\n`;
            if (email) {
                message += `ðŸ“§ *Email:* ${email}\n`;
            }
            message += `ðŸ“± *Phone:* ${phone}\n`;
            message += `ðŸ“ *Address:* ${address}\n`;
            if (notes) {
                message += `ðŸ“ *Notes:* ${notes}\n`;
            }
            
            message += `\n*ðŸ›’ Order Summary*\n\n`;
            let subtotal = 0;
            
            // Add each item to the message
            cart.forEach((item, index) => {
                const itemPrice = parseFloat(item.price);
                const quantity = parseInt(item.quantity) || 1;
                const itemTotal = itemPrice * quantity;
                subtotal += itemTotal;
                
                message += `*${index + 1}. ${item.name}*\n`;
                message += `   Quantity: ${quantity}\n`;
                message += `   Price: ${formatPrice(itemPrice)} each\n`;
                message += `   Total: ${formatPrice(itemTotal)}\n\n`;
            });
            
            // Add order summary
            message += `*Order Total: ${formatPrice(subtotal)}*\n\n`;
            message += `Thank you for your order! We'll contact you shortly to confirm your order and provide shipping details.`;

            // WhatsApp number (Jay Kelly Rahp's WhatsApp number)
            const whatsappNumber = '233271326182';
            
            // Send to WhatsApp
            sendToWhatsApp(whatsappNumber, message);

            // Show success message
            showNotification('Order sent! Check your WhatsApp to continue.');
            
            // Clear the cart and form
            localStorage.removeItem('cart');
            document.getElementById('checkout-form').reset();
            
            // Update the cart display
            updateCartDisplay();
            
            // Redirect to shop page after a short delay
            setTimeout(() => {
                window.location.href = 'shop.html';
            }, 2000);
        });
        
        // Initialize cart display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // This will be handled by checkout.js
            if (typeof renderCheckout === 'function') {
                renderCheckout();
            }
        });
    </script>
</body>
</html>